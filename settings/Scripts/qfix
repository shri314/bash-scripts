#!/bin/bash

usage()
{
    echo "usage: qfix [--vim|--gvim] [-g] [<--split>|<--no-split>] [--help]"
}

ED_NAME="vim"
ED_OPTS=()
ED_ARGS=('+copen')

while [ $# -gt 0 ]
do
    case "$1" in
        --no-split)
            ED_ARGS+=( '+set switchbuf-=split' )
            ;;
        --split)
            ED_ARGS+=( '+set switchbuf+=split' )
            ;;
        --vim)
            ED_NAME='vim'
            ;;
        --gvim)
            ED_NAME='gvim'
            ;;
        -g)
            ED_OPTS+=('-g')
            ;;
        --help)
            usage
            exit 0
            ;;
    esac
    shift
done

EFILE=$(mktemp /tmp/qfix.XXXXXX)

if which paint 1>/dev/null 2>/dev/null
then
   ( cat | tee "$EFILE" | paint )
else
   ( cat | tee "$EFILE" )
fi

# Regular expression to find pattern ':<digits>:'
if grep -q -e "\:[[:digit:]]\+\:" $EFILE
then
    if [ $(cat "$EFILE" | sed -e "/^ *$/d" | wc -l) -gt 0 ]
    then
        ( exec </dev/tty; "${ED_NAME}" "${ED_ARGS[@]}" "${ED_OPTS[@]}" -q "$EFILE" )
        exit 1
    fi
fi

exit 0
